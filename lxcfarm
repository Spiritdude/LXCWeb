#!/usr/bin/perl

# -- LXC Farm, written by Rene K. Mueller <spiritdude@gmail.com>
#
$VERSION = '0.006';
$APPNAME = 'lxcfarm';
#
# License: GPLv2
#
# History:
# 2012/11/30: initial version

use File::Copy;

$conf{homerun} = '/var/lib/lxc';

while($#ARGV>=0) {
   my $a = shift(@ARGV);
   $do = $a, next unless($do);
   $orig = shift(@ARGV), next if($a eq '-o');
   $temp = shift(@ARGV), next if($a eq '-t');
   $name = $a, next unless($name);
   $n = $a, next unless($n);
}

$temp = 'ubuntu' unless($temp);
$n = 1 unless($n);
my $i = 0;

$n = $2-$1+1, $range = $name, $name =~ s/(\D+\d+).*/$1/ if($name=~/(\d+)\.\.\D*(\d+)/);
print "$APPNAME: perform $do on $n ".($range?"($range) ":"")."containers:\n";

while($i<$n) {
   if($do eq 'create'&&-e "$conf{homerun}/$name") {
      print "\tskipping $name, exists already\n";
      $n-- if($range);

   } else {
      print "\t",($i+1)," of $n".($range?" ($name)":"").": ";
      if($do eq 'create') {
         if($orig) {
            print "clone $orig to $name\n";
            `lxc-clone -o $orig -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;
            copy("$conf{homerun}/$orig/lxcweb.inf","$conf{homerun}/$name/lxcweb.inf");

         } else {
            print "create $name ($temp)\n";
            `lxc-create -t $temp -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;
            open(F,">$conf{homerun}/$name/lxcweb.inf");
            print F "type: $temp\nctime: ".time()."\n";
            close(F);
         }
         
      } elsif($do eq 'start') {
         print "start $name\n";
         if(1) {
            `lxc-start -n $name -d --logfile=$conf{homerun}/$name/lxcweb-error.log`;
         } else {
            if(fork()==0) {
               `lxc-start -n $name --logfile=$conf{homerun}/$name/lxcweb-error.log`;
               exit(0);
            }
         }
         open(F,">$conf{homerun}/$name/.stamp.run"); close(F);
         sleep(1);
         
      } elsif($do eq 'freeze') {
         print "freeze $name\n";
         `lxc-freeze -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;

      } elsif($do eq 'unfreeze') {
         print "unfreeze $name\n";
         `lxc-unfreeze -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;
         
      } elsif($do eq 'stop') {
         print "stop $name\n";
         `lxc-stop -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;
         unlink("$conf{homerun}/$name/.stamp.run");
         
      } elsif($do eq 'destroy') {
         print "destroy $name\n";
         `lxc-destroy -n $name`; # --logfile=$conf{homerun}/$name/lxcweb-error.log`;
         
      } else {
         print "Error: unknown command $do\n";
         usage();
      }
      $i++;
   }
   $name++;
}


sub usage {
   print "\nUsage $APPNAME: {-o [clone-base]} {-t [template]} [cmd] {[n]}\n\t-o clone-base\te.g. -o ubu00\n\t-t template\te.g. -t ubuntu\n\tcmd\t\tcommand: {start,stop,create,freeze,unfreeze,destroy}\n\tn\t\tn times follow up\n";
   print "\nExamples:\n\tlxcfarm create -t ubuntu ubu00\n\tlxcfarm create -o ubu00 ubu01..20\n\tlxcfarm start ubu01..20\n";
   exit 1;
}

